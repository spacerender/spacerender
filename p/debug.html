<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debug - API Status Check</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">üîß API Status Check</h1>
      
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl mb-4">API Endpoint Tests</h2>
        <div id="api-results" class="space-y-4">
          <!-- Results will be populated here -->
        </div>
        <button onclick="testAllAPIs()" class="mt-4 px-6 py-2 bg-blue-600 rounded hover:bg-blue-700">
          Test All APIs
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-lg p-6 mb-6">
        <h2 class="text-xl mb-4">Payment System Status</h2>
        <div id="payment-status" class="mb-4">
          <p class="text-gray-400">Click "Test Payment System" to check status</p>
        </div>
        <button onclick="testPaymentSystem()" class="px-6 py-2 bg-green-600 rounded hover:bg-green-700">
          Test Payment System
        </button>
      </div>
      
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl mb-4">Local Storage Status</h2>
        <div id="storage-status">
          <!-- Storage status will be shown here -->
        </div>
        <button onclick="checkLocalStorage()" class="mt-4 px-6 py-2 bg-purple-600 rounded hover:bg-purple-700">
          Check Storage
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://spacerender.vercel.app/p';
    
    async function testAllAPIs() {
      const resultsDiv = document.getElementById('api-results');
      resultsDiv.innerHTML = '<p class="text-blue-400">Testing APIs...</p>';
      
      const endpoints = [
        { name: 'Create Order', url: '/api/create-order', method: 'POST', body: { amount: 999, user_email: 'test@example.com' } },
        { name: 'Verify Payment', url: '/api/verify-payment', method: 'POST', body: { payment_id: 'test', order_id: 'test', signature: 'test', user_email: 'test@example.com' } },
        { name: 'Models', url: '/api/models', method: 'GET', params: '?user_email=test@example.com' },
        { name: 'Payment Status', url: '/api/user/test@example.com/payment-status', method: 'GET' },
        { name: 'Admin - Paid Users', url: '/api/admin/paid-users', method: 'GET' }
      ];
      
      let results = '';
      
      for (const endpoint of endpoints) {
        try {
          const url = `${API_BASE}${endpoint.url}${endpoint.params || ''}`;
          const options = {
            method: endpoint.method,
            headers: { 'Content-Type': 'application/json' }
          };
          
          if (endpoint.body) {
            options.body = JSON.stringify(endpoint.body);
          }
          
          const response = await fetch(url, options);
          const status = response.status;
          const statusText = response.statusText;
          
          let statusClass = 'text-red-400';
          let statusIcon = '‚ùå';
          
          if (status === 200) {
            statusClass = 'text-green-400';
            statusIcon = '‚úÖ';
          } else if (status === 404) {
            statusClass = 'text-yellow-400';
            statusIcon = '‚ö†Ô∏è';
          }
          
          results += `
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
              <span>${endpoint.name}</span>
              <span class="${statusClass}">${statusIcon} ${status} ${statusText}</span>
            </div>
          `;
        } catch (error) {
          results += `
            <div class="flex justify-between items-center p-3 bg-gray-700 rounded">
              <span>${endpoint.name}</span>
              <span class="text-red-400">‚ùå Network Error</span>
            </div>
          `;
        }
      }
      
      resultsDiv.innerHTML = results;
    }
    
    async function testPaymentSystem() {
      const statusDiv = document.getElementById('payment-status');
      statusDiv.innerHTML = '<p class="text-blue-400">Testing payment system...</p>';
      
      // Test Razorpay key
      const razorpayKey = 'rzp_live_RJn6bJb2qAHcuW';
      let razorpayStatus = '‚ùå Razorpay not loaded';
      
      if (typeof Razorpay !== 'undefined') {
        razorpayStatus = '‚úÖ Razorpay loaded successfully';
      } else {
        // Try to load Razorpay
        try {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://checkout.razorpay.com/v1/checkout.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
          razorpayStatus = '‚úÖ Razorpay loaded dynamically';
        } catch (e) {
          razorpayStatus = '‚ùå Failed to load Razorpay';
        }
      }
      
      // Test GitHub API
      let githubStatus = '‚ùå GitHub API failed';
      try {
        const response = await fetch('https://api.github.com/repos/spacerender/sketchup-models/git/trees/main?recursive=1');
        if (response.ok) {
          const data = await response.json();
          const skpCount = data.tree.filter(f => f.path.endsWith('.skp')).length;
          githubStatus = `‚úÖ GitHub API working (${skpCount} .skp files found)`;
        }
      } catch (e) {
        githubStatus = '‚ùå GitHub API network error';
      }
      
      statusDiv.innerHTML = `
        <div class="space-y-2">
          <div class="flex justify-between p-3 bg-gray-700 rounded">
            <span>Razorpay SDK</span>
            <span>${razorpayStatus}</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-700 rounded">
            <span>GitHub API</span>
            <span>${githubStatus}</span>
          </div>
          <div class="flex justify-between p-3 bg-gray-700 rounded">
            <span>Razorpay Key</span>
            <span class="text-green-400">‚úÖ ${razorpayKey}</span>
          </div>
        </div>
      `;
    }
    
    function checkLocalStorage() {
      const statusDiv = document.getElementById('storage-status');
      
      const paidUsers = JSON.parse(localStorage.getItem('paid_users') || '[]');
      let userPayments = [];
      
      paidUsers.forEach(email => {
        const paymentKey = `payment_${email}`;
        const payment = localStorage.getItem(paymentKey);
        if (payment) {
          try {
            const data = JSON.parse(payment);
            userPayments.push({ email, payment: data });
          } catch (e) {
            userPayments.push({ email, payment: 'Invalid data' });
          }
        }
      });
      
      let html = `
        <div class="space-y-4">
          <div>
            <h3 class="text-lg font-semibold mb-2">Paid Users: ${paidUsers.length}</h3>
            ${paidUsers.length > 0 ? 
              paidUsers.map(email => `<div class="text-sm text-gray-300">‚Ä¢ ${email}</div>`).join('') :
              '<div class="text-sm text-gray-400">No paid users found</div>'
            }
          </div>
          
          <div>
            <h3 class="text-lg font-semibold mb-2">Payment Data: ${userPayments.length}</h3>
            ${userPayments.map(item => `
              <div class="text-sm bg-gray-700 p-2 rounded mb-1">
                <strong>${item.email}</strong><br>
                ${typeof item.payment === 'object' ? 
                  `Payment ID: ${item.payment.payment_id}<br>Status: ${item.payment.status}` :
                  item.payment
                }
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      statusDiv.innerHTML = html;
    }
    
    // Auto-run tests on load
    window.addEventListener('load', () => {
      checkLocalStorage();
    });
  </script>
</body>
</html>