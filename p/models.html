<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premium SketchUp Models</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC0QGaDKrKzb7SGcQ3K3Sw2oI8-qIIRkHs",
      authDomain: "archviz-models.firebaseapp.com",
      projectId: "archviz-models",
      storageBucket: "archviz-models.appspot.com",
      messagingSenderId: "222151849439",
      appId: "1:222151849439:web:3db08b239edc40e889806a",
      measurementId: "G-LL0PFNZFGW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let currentUser = null;

    // Check authentication and payment status
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      checkAccess();
    });

    function checkAccess() {
      const paymentData = localStorage.getItem('payment_data');
      
      if (!currentUser) {
        showAccessDenied("Please login first to access premium models.");
        return;
      }

      if (!paymentData) {
        showAccessDenied("Payment required to access premium models.");
        return;
      }

      try {
        const payment = JSON.parse(paymentData);
        if (payment.status === 'completed') {
          showModelsLibrary();
        } else {
          showAccessDenied("Payment verification failed.");
        }
      } catch (e) {
        showAccessDenied("Invalid payment data.");
      }
    }

    function showAccessDenied(message) {
      document.getElementById("models-content").innerHTML = `
        <div class="text-center">
          <div class="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg mb-6">
            <h2 class="text-xl font-bold mb-2">üîí Access Denied</h2>
            <p>${message}</p>
          </div>
          <a href="test.html" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Back to Dashboard
          </a>
        </div>
      `;
    }

    function showModelsLibrary() {
      document.getElementById("user-info").innerHTML = `
        Welcome, <b>${currentUser.displayName}</b> | Premium Access ‚úÖ
      `;
      loadModels();
    }

    // Models configuration - UPDATE THIS SECTION TO ADD NEW MODELS
    const MODELS_CONFIG = {
      // GitHub repository settings
      github: {
        username: "spacerender", // Your GitHub username
        repository: "sketchup-models", // Your repository name
        branch: "main" // or "master" depending on your default branch
      },
      
      // Your SketchUp models - Add new models here
      models: [
        {
          id: 1,
          name: "Modern House Design",
          description: "Contemporary residential architecture with clean lines",
          size: "2.5 MB",
          category: "Residential",
          tags: ["modern", "house", "residential"],
          thumbnail: "https://raw.githubusercontent.com/spacerender/sketchup-models/main/thumbnails/modern-house.jpg",
          downloadUrl: "https://github.com/spacerender/sketchup-models/raw/main/residential/modern-house.skp",
          previewUrl: "https://github.com/spacerender/sketchup-models/blob/main/residential/modern-house.skp",
          dateAdded: "2024-01-15"
        },
        {
          id: 2,
          name: "Office Building Complex",
          description: "Multi-story commercial office building with parking",
          size: "4.1 MB",
          category: "Commercial",
          tags: ["office", "commercial", "building"],
          thumbnail: "https://raw.githubusercontent.com/spacerender/sketchup-models/main/thumbnails/office-building.jpg",
          downloadUrl: "https://github.com/spacerender/sketchup-models/raw/main/commercial/office-building.skp",
          previewUrl: "https://github.com/spacerender/sketchup-models/blob/main/commercial/office-building.skp",
          dateAdded: "2024-01-20"
        },
        {
          id: 3,
          name: "Interior Living Room",
          description: "Fully furnished modern living room with detailed textures",
          size: "3.2 MB",
          category: "Interior",
          tags: ["interior", "living room", "furniture"],
          thumbnail: "https://raw.githubusercontent.com/spacerender/sketchup-models/main/thumbnails/living-room.jpg",
          downloadUrl: "https://github.com/spacerender/sketchup-models/raw/main/interior/living-room.skp",
          previewUrl: "https://github.com/spacerender/sketchup-models/blob/main/interior/living-room.skp",
          dateAdded: "2024-01-25"
        }
      ]
    };

    async function loadModels() {
      showLoadingState();
      
      try {
        // Try to load from GitHub API first (if configured)
        if (MODELS_CONFIG.github.username && MODELS_CONFIG.github.repository) {
          await loadFromGitHub();
        } else {
          // Fall back to manual list
          displayModels(MODELS_CONFIG.models);
        }
      } catch (error) {
        console.error("Error loading models:", error);
        displayModels(MODELS_CONFIG.models); // Fallback to manual list
      }
    }

    async function loadFromGitHub() {
      const { username, repository, branch } = MODELS_CONFIG.github;
      
      // Get repository contents
      const response = await fetch(
        `https://api.github.com/repos/${username}/${repository}/git/trees/${branch}?recursive=1`
      );
      
      if (!response.ok) throw new Error('Failed to fetch from GitHub');
      
      const data = await response.json();
      
      // Filter .skp files
      const skpFiles = data.tree.filter(file => 
        file.path.endsWith('.skp') && file.type === 'blob'
      );
      
      const githubModels = skpFiles.map((file, index) => {
        const pathParts = file.path.split('/');
        const fileName = pathParts[pathParts.length - 1];
        const category = pathParts[0] || 'Uncategorized';
        const modelName = fileName.replace('.skp', '').replace(/[-_]/g, ' ');
        
        return {
          id: `github_${file.sha.substring(0, 8)}`,
          name: modelName.charAt(0).toUpperCase() + modelName.slice(1),
          description: `SketchUp model from ${category} collection`,
          size: "GitHub hosted",
          category: category.charAt(0).toUpperCase() + category.slice(1),
          tags: ["sketchup", "model", category.toLowerCase()],
          thumbnail: `https://raw.githubusercontent.com/${username}/${repository}/${branch}/thumbnails/${fileName.replace('.skp', '')}.jpg`,
          downloadUrl: `https://github.com/${username}/${repository}/raw/${branch}/${file.path}`,
          previewUrl: `https://github.com/${username}/${repository}/blob/${branch}/${file.path}`,
          dateAdded: new Date().toISOString().split('T')[0]
        };
      });
      
      // Combine GitHub auto-detected models with manual models
      const allModels = [...githubModels, ...MODELS_CONFIG.models];
      
      // Remove duplicates based on download URL
      const uniqueModels = allModels.filter((model, index, self) => 
        index === self.findIndex(m => m.downloadUrl === model.downloadUrl)
      );
      
      displayModels(uniqueModels);
    }

    function formatFileSize(bytes) {
      if (!bytes || bytes === "GitHub hosted") return "GitHub hosted";
      if (typeof bytes === 'string') return bytes;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showLoadingState() {
      document.getElementById("models-content").innerHTML = `
        <div class="text-center py-12">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <p class="text-gray-400">Loading premium models...</p>
        </div>
      `;
    }

    function displayModels(models) {
      const categories = [...new Set(models.map(m => m.category))];
      let html = '';

      // Add search and filter
      html += `
        <div class="mb-6">
          <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex-1 min-w-64">
              <input type="text" id="search-models" placeholder="Search models..." 
                     onkeyup="filterModels()" 
                     class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
            </div>
            <select id="category-filter" onchange="filterModels()" 
                    class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
              <option value="">All Categories</option>
              ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>
        </div>
      `;

      // Add models grid
      html += `
        <div id="models-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${models.map(model => `
            <div class="model-card bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-750 transition-colors" 
                 data-category="${model.category}" data-tags="${model.tags.join(' ')}" data-name="${model.name}">
              <img src="${model.thumbnail}" alt="${model.name}" class="w-full h-48 object-cover">
              <div class="p-4">
                <h3 class="text-lg font-semibold mb-2">${model.name}</h3>
                <p class="text-gray-400 text-sm mb-3">${model.description}</p>
                <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                  <span>üìÅ ${model.size}</span>
                  <span>üìÖ ${new Date(model.dateAdded).toLocaleDateString()}</span>
                </div>
                <div class="flex gap-2 mb-3">
                  ${model.tags.map(tag => `<span class="px-2 py-1 bg-gray-700 rounded text-xs">${tag}</span>`).join('')}
                </div>
                <div class="flex gap-2">
                  <a href="${model.downloadUrl}" class="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-center text-sm"
                     onclick="trackDownload('${model.name}')">
                    üì• Download
                  </a>
                  <a href="${model.previewUrl}" target="_blank" 
                     class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                    üëÅÔ∏è Preview
                  </a>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById("models-content").innerHTML = html;
    }

    window.filterModels = function() {
      const searchTerm = document.getElementById('search-models').value.toLowerCase();
      const categoryFilter = document.getElementById('category-filter').value;
      const cards = document.querySelectorAll('.model-card');

      cards.forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const tags = card.dataset.tags.toLowerCase();
        const category = card.dataset.category;
        
        const matchesSearch = name.includes(searchTerm) || tags.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        
        card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
      });
    };

    window.trackDownload = function(modelName) {
      console.log(`Download tracked: ${modelName}`);
      // You can add analytics tracking here
    };

    // Initialize on page load
    window.addEventListener('load', () => {
      if (!currentUser) {
        checkAccess();
      }
    });
  </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">üèóÔ∏è Premium SketchUp Models</h1>
        <a href="test.html" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">
          ‚Üê Back to Dashboard
        </a>
      </div>
      <div id="user-info" class="text-gray-400"></div>
    </div>

    <!-- Main Content -->
    <div id="models-content">
      <div class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p class="text-gray-400">Checking access...</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-12 pt-8 border-t border-gray-700 text-center text-gray-400">
      <p>Premium SketchUp Models Collection</p>
      <p class="text-sm mt-2">For support, contact us through your premium dashboard</p>
    </div>
  </div>
</body>
</html>